<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Recibos SJ Gardens</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f4f8;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 600px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
}
h2 { text-align: center; color: #1b4b8a; }
label { font-weight: bold; margin-top: 12px; display: block; }
input, select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  width: 100%;
  padding: 12px;
  margin-top: 20px;
  background: #1b4b8a;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
}
button:hover { background: #163b6c; }
.success {
  background: #d1fae5;
  padding: 12px;
  border-radius: 6px;
  color: #065f46;
  margin-top: 10px;
  display: none;
}
.error {
  background: #fee2e2;
  padding: 12px;
  border-radius: 6px;
  color: #991b1b;
  margin-top: 10px;
  display: none;
}
footer {
  margin-top: 25px;
  text-align: center;
  color: #666;
  font-size: 13px;
}
</style>
</head>

<body>
<div class="container">
  <h2>EmisiÃ³n de Recibos â€“ SJ Gardens</h2>

  <div id="success" class="success"></div>
  <div id="error" class="error"></div>

  <label>Vivienda</label>
  <select id="vivienda"></select>

  <label>Copropietario</label>
  <input id="copropietario" disabled />

  <label>Concepto de Pago</label>
  <input id="concepto" placeholder="Ej: AlÃ­cuota mensual" />

  <label>Valor (USD)</label>
  <input id="valor" type="number" step="0.01" placeholder="Ej: 25.00" />

  <button id="btnEnviar">Generar Recibo</button>

  <footer>SJ Gardens â€“ AdministraciÃ³n</footer>
</div>

<script>
// =============================
// CONFIGURA TU WEB APP URL ðŸ‘‡
// =============================
const API_URL = "https://script.google.com/macros/s/AKfycbytkPHWl21LNffEBT7X6nwJV3jzTRXqSXzzqVj0FWIPPngHpQSV2WaaIwT2IiXLAx7cWQ/exec"; // reemplaza con tu web app

document.addEventListener("DOMContentLoaded", function() {

  const viviendaSelect = document.getElementById("vivienda");
  const copropietarioInput = document.getElementById("copropietario");
  const btnEnviar = document.getElementById("btnEnviar");

  // Cargar viviendas
  async function cargarViviendas() {
    try {
      const resp = await fetch(API_URL + "?action=getViviendas", { method: "GET", mode: "cors" });
      const data = await resp.json();

      if (!data || data.status !== "ok" || !Array.isArray(data.viviendas)) {
        mostrarError("No se pudieron cargar las viviendas.");
        return;
      }

      viviendaSelect.innerHTML = "";
      data.viviendas.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.vivienda;
        opt.dataset.dueno = v.copropietario;
        viviendaSelect.appendChild(opt);
      });
      actualizarCopropietario();

    } catch (e) {
      mostrarError("Error al conectar con el servidor.");
      console.error(e);
    }
  }

  function actualizarCopropietario() {
    const dueno = viviendaSelect.options[viviendaSelect.selectedIndex]?.dataset?.dueno || "";
    copropietarioInput.value = dueno;
  }

  viviendaSelect.addEventListener("change", actualizarCopropietario);

  async function enviarRecibo() {
    const vivienda = viviendaSelect.value;
    const concepto = document.getElementById("concepto").value;
    const valor = document.getElementById("valor").value;

    if (!vivienda || !concepto || !valor) {
      mostrarError("Debe completar vivienda, concepto y valor.");
      return;
    }

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vivienda, concepto, valor })
      });

      const data = await resp.json();

      if (data.status === "ok") {
        mostrarSuccess(`Recibo generado. NÂº: ${data.numeroRecibo}`);
        document.getElementById("concepto").value = "";
        document.getElementById("valor").value = "";
      } else {
        mostrarError(data.message || "Hubo un problema generando el recibo.");
      }

    } catch (err) {
      mostrarError("Error comunicando con el servidor.");
      console.error(err);
    }
  }

  btnEnviar.addEventListener("click", enviarRecibo);

  function mostrarSuccess(msg) {
    document.getElementById("success").innerText = msg;
    document.getElementById("success").style.display = "block";
    document.getElementById("error").style.display = "none";
  }

  function mostrarError(msg) {
    document.getElementById("error").innerText = msg;
    document.getElementById("error").style.display = "block";
    document.getElementById("success").style.display = "none";
  }

  // Inicia carga de viviendas
  cargarViviendas();

});
</script>

</body>

</html>
